name: NotenVonSchuelernFuerLehrer

services:
  mysql:
    image: mysql:9.4
    container_name: MySql
    environment:
      MYSQL_ROOT_PASSWORD: Test
    volumes:
      - mysql:/var/lib/mysql
    # ports:
    #   - "3306:3306"
    #   - "33060:33060"

  webapi:
    build:
      context: WebApi/
      dockerfile: NotenVonSchuelernFuerLehrer.WebApi/Dockerfile
    container_name: WebApi
    depends_on:
      - mysql
    environment:
      ConnectionStrings__NotenVonSchuelernFuerLehrerConnectionString: "Server=MySql;Port=3306;Database=NotenVonSchuelernFuerLehrer;User=root;Password=Test;"
      ASPNETCORE_ENVIRONMENT: "Development"
      Note__MinWert: "1"
      Note__MaxWert: "6"
      Jwt__Key: "TeIvOVCK01UzOVQw6cBLR3IL1R9D5sBC8O04PbCi5ZE3h8cGoU"
      ShouldMigrateDatabase: "true"
      ShouldSeedDatabase: "true"
      # Seed-Modus: "full" = alle Demo-Daten, "minimal" = nur ein Admin-Lehrer
      SeedMode: "${SEED_MODE:-full}"
    # ports:
    #   - "8080:8080"
    #   - "8081:8081"

  webapp:
    build:
      context: WebApp/
      dockerfile: Dockerfile
    container_name: WebApp
    depends_on:
      - webapi
    # ports:
    #   - "3000:80"
    
  yarp:
    build:
      context: Proxy/
      dockerfile: Dockerfile
      args:
        CERT_PASSWORD: "${CERT_PASSWORD:-changeit}"
    container_name: Yarp
    depends_on:
      - webapi
      - webapp
    environment:
    # Passwort für das Zertifikat (Standard: changeit)
      Kestrel__Certificates__Default__Password: "${CERT_PASSWORD:-changeit}"
    # TLS 1.3 erzwingen - für stabile Demo auskommentiert (Kompatibilität mit älteren Clients)
    #   Kestrel__Endpoints__Https__SslProtocols: "Tls13"
    # Für externes Zertifikat: auskommentieren und cert.pfx in ./Proxy/certs/ ablegen
    # volumes:
    #   - ./Proxy/certs/cert.pfx:/app/cert.pfx:ro
    ports:
      - "5001:5001"   # HTTPS (default)
      # - "5000:5000" # HTTP (unverschlüsselt) - für weitere Reverse Proxies intern verfügbar

volumes:
  mysql:
    name: MySql